@page "/reserver/{VehiculeId:int}"
@rendermode InteractiveServer
@using rntlOS.Core.Services
@using rntlOS.Core.Models
@using rntlOS.FrontOffice.Services
@inject VehiculeService VehiculeService
@inject BookingService BookingService
@inject EmailService EmailService
@inject AuthenticationStateService AuthService
@inject NavigationManager Navigation

<PageTitle>Réserver - rntlOS</PageTitle>

<div class="container mt-5">
    @if (vehicule == null)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-gold" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Véhicule Info -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="vehicle-image-container-res">
                        @if (vehicule.Images?.Any() == true)
                        {
                            <img src="@GetImagePath(vehicule.Images.First().ImagePath)" 
                                 class="vehicle-image-res" 
                                 alt="@vehicule.Marque @vehicule.Modele" />
                        }
                    </div>
                    <div class="card-body">
                        <h3 class="card-title">@vehicule.Marque @vehicule.Modele</h3>
                        <p class="card-text">
                            <span class="badge">@vehicule.TypeVehicule?.Libelle</span>
                        </p>
                        <div class="vehicle-details mt-4">
                            <div class="detail-item d-flex align-items-center mb-3">
                                <span class="oi oi-euro text-gold me-3 fs-5"></span>
                                <div>
                                    <strong class="text-gold fs-5">@vehicule.PrixParJour.ToString("C")</strong> <span class="text-dim">/ jour</span>
                                </div>
                            </div>
                            <div class="detail-item d-flex align-items-center">
                                <span class="oi oi-dashboard text-gold me-3 fs-5"></span>
                                <span class="text-dim">@vehicule.Kilometrage.ToString("N0") km</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire Réservation -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h4 class="mb-0">Votre Réservation</h4>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(messageErreur))
                        {
                            <div class="alert alert-danger mb-3">
                                <span class="oi oi-warning me-2"></span> @messageErreur
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(messageSucces))
                        {
                            <div class="alert alert-success mb-3">
                                <span class="oi oi-check me-2"></span> @messageSucces
                            </div>
                        }

                        <EditForm Model="@reservationModel" OnValidSubmit="@CreerReservation">
                            <div class="mb-4">
                                <label class="form-label">Date de début</label>
                                <InputDate class="form-control" @bind-Value="reservationModel.DateDebut" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Date de fin</label>
                                <InputDate class="form-control" @bind-Value="reservationModel.DateFin" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>

                            @if (nombreJours > 0 && prixTotal > 0)
                            {
                                <div class="glass-panel p-3 mb-4 border-left-gold">
                                    <h5 class="text-gold mb-3">Récapitulatif</h5>
                                    <div class="d-flex justify-content-between mb-2">
                                        <span class="text-dim">Durée</span>
                                        <strong class="text-white">@nombreJours jour(s)</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-dim">Total</span>
                                        <strong class="text-gold fs-5">@prixTotal.ToString("C")</strong>
                                    </div>
                                </div>
                            }

                            <button type="submit" class="btn btn-primary w-100" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                <span class="oi oi-check me-2"></span> Confirmer la réservation
                            </button>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .vehicle-image-container-res {
        height: 300px;
        overflow: hidden;
        border-bottom: 1px solid rgba(212, 175, 55, 0.2);
    }

    .vehicle-image-res {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .border-left-gold {
        border-left: 3px solid var(--gold-primary);
    }
</style>

@code {
    [Parameter]
    public int VehiculeId { get; set; }

    private Vehicule? vehicule;
    private ReservationModel reservationModel = new();
    private string messageErreur = "";
    private string messageSucces = "";
    private bool isSubmitting = false;

    private int nombreJours => (reservationModel.DateFin - reservationModel.DateDebut).Days;
    private decimal prixTotal => nombreJours > 0 ? nombreJours * (vehicule?.PrixParJour ?? 0) : 0;

    protected override async Task OnInitializedAsync()
    {
        vehicule = await VehiculeService.GetByIdAsync(VehiculeId);
        
        // Dates par défaut
        reservationModel.DateDebut = DateTime.Today;
        reservationModel.DateFin = DateTime.Today.AddDays(1);
    }

    private async Task CreerReservation()
    {
        messageErreur = "";
        messageSucces = "";
        isSubmitting = true;

        try
        {
            // Vérifier si connecté
            if (!AuthService.IsAuthenticated)
            {
                Navigation.NavigateTo($"/login?returnUrl=/reserver/{VehiculeId}");
                return;
            }

            // Validation dates
            if (reservationModel.DateDebut < DateTime.Today)
            {
                messageErreur = "La date de début ne peut pas être dans le passé.";
                isSubmitting = false;
                return;
            }

            if (reservationModel.DateFin <= reservationModel.DateDebut)
            {
                messageErreur = "La date de fin doit être après la date de début.";
                isSubmitting = false;
                return;
            }

            // Vérifier disponibilité
            var estDisponible = await BookingService.VehiculeEstDisponible(
                VehiculeId, 
                reservationModel.DateDebut, 
                reservationModel.DateFin
            );

            if (!estDisponible)
            {
                messageErreur = "Désolé, ce véhicule n'est pas disponible pour ces dates.";
                isSubmitting = false;
                return;
            }

            // Créer la réservation
            var booking = new Booking
            {
                VehiculeId = VehiculeId,
                ClientId = AuthService.CurrentUser!.Id,
                DateDebut = reservationModel.DateDebut,
                DateFin = reservationModel.DateFin,
                PrixTotal = prixTotal,
                Status = StatutReservation.EnAttente,
                CreatedAt = DateTime.UtcNow
            };

            await BookingService.AddAsync(booking);

            // Recharger le booking avec Client et Vehicule pour l'email
            var bookingComplet = await BookingService.GetByIdAsync(booking.Id);

            // Envoyer email de confirmation (en arrière-plan, ne pas bloquer)
            try
            {
                if (bookingComplet != null)
                {
                    _ = EmailService.EnvoyerEmailConfirmationReservation(bookingComplet);
                }
            }
            catch
            {
                // L'email a échoué mais on continue quand même
            }

            // Rediriger vers confirmation avec l'ID du booking
            Navigation.NavigateTo($"/confirmation?bookingId={booking.Id}");
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur: {ex.Message}";
            isSubmitting = false;
        }
    }

    private string GetImagePath(string imagePath)
    {
        if (string.IsNullOrEmpty(imagePath))
            return "/images/no-image.png";
            
        return $"/Images/{imagePath}";
    }

    public class ReservationModel
    {
        public DateTime DateDebut { get; set; } = DateTime.Today;
        public DateTime DateFin { get; set; } = DateTime.Today.AddDays(1);
    }
}
