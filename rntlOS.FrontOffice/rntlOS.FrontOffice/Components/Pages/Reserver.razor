@page "/reserver/{VehiculeId:int}"
@rendermode InteractiveServer
@using rntlOS.Core.Services
@using rntlOS.Core.Models
@using rntlOS.FrontOffice.Services
@inject VehiculeService VehiculeService
@inject BookingService BookingService
@inject EmailService EmailService
@inject AuthenticationStateService AuthService
@inject NavigationManager Navigation

<PageTitle>Réserver - rntlOS</PageTitle>

<div class="container mt-5">
    @if (vehicule == null)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>
    }
    else
    {
        <div class="row">
            <!-- Véhicule Info -->
            <div class="col-md-6">
                <div class="card">
                    @if (vehicule.Images?.Any() == true)
                    {
                        <img src="@GetImagePath(vehicule.Images.First().ImagePath)" 
                             class="card-img-top" 
                             alt="@vehicule.Marque @vehicule.Modele" />
                    }
                    <div class="card-body">
                        <h3 class="card-title">@vehicule.Marque @vehicule.Modele</h3>
                        <p class="card-text">
                            <span class="badge bg-primary">@vehicule.TypeVehicule?.Libelle</span>
                        </p>
                        <div class="vehicle-details">
                            <div class="detail-item">
                                <span class="oi oi-euro"></span>
                                <strong>@vehicule.PrixParJour.ToString("C")</strong> / jour
                            </div>
                            <div class="detail-item">
                                <span class="oi oi-dashboard"></span>
                                @vehicule.Kilometrage.ToString("N0") km
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire Réservation -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>Réservation</h4>
                    </div>
                    <div class="card-body">
                        @if (!string.IsNullOrEmpty(messageErreur))
                        {
                            <div class="alert alert-danger">@messageErreur</div>
                        }

                        @if (!string.IsNullOrEmpty(messageSucces))
                        {
                            <div class="alert alert-success">@messageSucces</div>
                        }

                        <EditForm Model="@reservationModel" OnValidSubmit="@CreerReservation">
                            <div class="mb-3">
                                <label class="form-label">Date de début</label>
                                <InputDate class="form-control" @bind-Value="reservationModel.DateDebut" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Date de fin</label>
                                <InputDate class="form-control" @bind-Value="reservationModel.DateFin" min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                            </div>

                            @if (nombreJours > 0 && prixTotal > 0)
                            {
                                <div class="alert alert-info">
                                    <h5>Récapitulatif</h5>
                                    <p><strong>Durée:</strong> @nombreJours jour(s)</p>
                                    <p><strong>Prix total:</strong> @prixTotal.ToString("C")</p>
                                </div>
                            }

                            <button type="submit" class="btn btn-primary w-100" disabled="@isSubmitting">
                                @if (isSubmitting)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Confirmer la réservation
                            </button>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public int VehiculeId { get; set; }

    private Vehicule? vehicule;
    private ReservationModel reservationModel = new();
    private string messageErreur = "";
    private string messageSucces = "";
    private bool isSubmitting = false;

    private int nombreJours => (reservationModel.DateFin - reservationModel.DateDebut).Days;
    private decimal prixTotal => nombreJours > 0 ? nombreJours * (vehicule?.PrixParJour ?? 0) : 0;

    protected override async Task OnInitializedAsync()
    {
        vehicule = await VehiculeService.GetByIdAsync(VehiculeId);
        
        // Dates par défaut
        reservationModel.DateDebut = DateTime.Today;
        reservationModel.DateFin = DateTime.Today.AddDays(1);
    }

    private async Task CreerReservation()
    {
        messageErreur = "";
        messageSucces = "";
        isSubmitting = true;

        try
        {
            // Vérifier si connecté
            if (!AuthService.IsAuthenticated)
            {
                Navigation.NavigateTo($"/login?returnUrl=/reserver/{VehiculeId}");
                return;
            }

            // Validation dates
            if (reservationModel.DateDebut < DateTime.Today)
            {
                messageErreur = "La date de début ne peut pas être dans le passé.";
                isSubmitting = false;
                return;
            }

            if (reservationModel.DateFin <= reservationModel.DateDebut)
            {
                messageErreur = "La date de fin doit être après la date de début.";
                isSubmitting = false;
                return;
            }

            // Vérifier disponibilité
            var estDisponible = await BookingService.VehiculeEstDisponible(
                VehiculeId, 
                reservationModel.DateDebut, 
                reservationModel.DateFin
            );

            if (!estDisponible)
            {
                messageErreur = "Désolé, ce véhicule n'est pas disponible pour ces dates.";
                isSubmitting = false;
                return;
            }

            // Créer la réservation
            var booking = new Booking
            {
                VehiculeId = VehiculeId,
                ClientId = AuthService.CurrentUser!.Id,
                DateDebut = reservationModel.DateDebut,
                DateFin = reservationModel.DateFin,
                PrixTotal = prixTotal,
                Status = StatutReservation.EnAttente,
                CreatedAt = DateTime.UtcNow
            };

            await BookingService.AddAsync(booking);

            // Recharger le booking avec Client et Vehicule pour l'email
            var bookingComplet = await BookingService.GetByIdAsync(booking.Id);

            // Envoyer email de confirmation (en arrière-plan, ne pas bloquer)
            try
            {
                if (bookingComplet != null)
                {
                    _ = EmailService.EnvoyerEmailConfirmationReservation(bookingComplet);
                }
            }
            catch
            {
                // L'email a échoué mais on continue quand même
            }

            // Rediriger vers confirmation avec l'ID du booking
            Navigation.NavigateTo($"/confirmation?bookingId={booking.Id}");
        }
        catch (Exception ex)
        {
            messageErreur = $"Erreur: {ex.Message}";
            isSubmitting = false;
        }
    }

    private string GetImagePath(string imagePath)
    {
        if (string.IsNullOrEmpty(imagePath))
            return "/images/no-image.png";
            
        return $"/Images/{imagePath}";
    }

    public class ReservationModel
    {
        public DateTime DateDebut { get; set; } = DateTime.Today;
        public DateTime DateFin { get; set; } = DateTime.Today.AddDays(1);
    }
}

<style>
    .vehicle-details {
        margin-top: 1rem;
    }

    .detail-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }

    .detail-item:last-child {
        border-bottom: none;
    }

    .detail-item .oi {
        margin-right: 0.5rem;
        color: #C9A961;
    }
</style>
