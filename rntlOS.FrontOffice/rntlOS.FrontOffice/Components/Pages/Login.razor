@page "/login"
@rendermode InteractiveServer
@using rntlOS.Core.Services
@using rntlOS.Core.Models
@using rntlOS.FrontOffice.Services
@using BCryptLib = BCrypt.Net.BCrypt
@inject ClientService ClientService
@inject AuthenticationStateService AuthService
@inject NavigationManager Navigation

<PageTitle>Connexion - rntlOS</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5" style="min-width: 320px;">
            <div class="glass-panel p-4 p-md-5">
                <div class="text-center mb-4">
                     <span class="oi oi-person" style="font-size: 3rem; color: var(--gold-primary);"></span>
                    <h3 class="text-gold mt-3">Espace Membre</h3>
                    <p class="text-dim">Connectez-vous pour accéder à vos privilèges.</p>
                </div>

                @if (!string.IsNullOrEmpty(messageErreur))
                {
                    <div class="alert alert-danger">
                        <span class="oi oi-warning me-2"></span> @messageErreur
                    </div>
                }

                @if (!string.IsNullOrEmpty(messageSucces))
                {
                    <div class="alert alert-success">
                         <span class="oi oi-check me-2"></span> @messageSucces
                    </div>
                }

                <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
                    <DataAnnotationsValidator />

                    <div class="mb-4">
                        <label class="form-label text-white">Email</label>
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-end-0 text-gold"><span class="oi oi-envelope-closed"></span></span>
                            <InputText type="email" class="form-control border-start-0 ps-0" @bind-Value="loginModel.Email" placeholder="votre@email.com" />
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-white">Mot de passe</label>
                        <div class="input-group">
                             <span class="input-group-text bg-transparent border-end-0 text-gold"><span class="oi oi-key"></span></span>
                            <InputText type="password" class="form-control border-start-0 ps-0" @bind-Value="loginModel.Password" placeholder="••••••••" />
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100 mb-3 btn-lg">
                        Se connecter
                    </button>
                </EditForm>

                <div class="text-center mt-4">
                    <p class="text-dim mb-0">Nouveau client ?</p>
                    <a href="/register" class="text-gold text-decoration-none fw-bold">
                        Créer un compte exclusif
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string messageErreur = "";
    private string messageSucces = "";

    private async Task HandleLogin()
    {
        messageErreur = "";
        messageSucces = "";

        if (string.IsNullOrWhiteSpace(loginModel.Email) ||
            string.IsNullOrWhiteSpace(loginModel.Password))
        {
            messageErreur = "Veuillez remplir tous les champs.";
            return;
        }

        var clients = await ClientService.GetAllAsync();
        var client = clients.FirstOrDefault(c => c.Email.ToLower() == loginModel.Email.ToLower());

        if (client == null)
        {
            messageErreur = "Email ou mot de passe incorrect.";
            return;
        }

        if (!BCryptLib.Verify(loginModel.Password, client.PasswordHash))
        {
            messageErreur = "Email ou mot de passe incorrect.";
            return;
        }

        // Connexion réussie - Sauvegarder la session
        AuthService.Login(client);
        messageSucces = $"Bienvenue {client.Prenom} !";

        // Rediriger vers la page d'accueil après 1 seconde
        await Task.Delay(1000);
        Navigation.NavigateTo("/");
    }

    public class LoginModel
    {
        public string Email { get; set; } = "";
        public string Password { get; set; } = "";
    }
}