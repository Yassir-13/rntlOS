@page "/confirmation"
@rendermode InteractiveServer
@using rntlOS.Core.Services
@using rntlOS.Core.Models
@using rntlOS.Core.PdfService
@inject BookingService BookingService
@inject ReservationPdfService PdfService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Confirmation - rntlOS</PageTitle>

<div class="container mt-5">
    @if (booking == null)
    {
        <div class="glass-panel p-5 text-center">
            <div class="mb-4">
                <span class="oi oi-circle-check" style="font-size: 4rem; color: var(--success);"></span>
            </div>

            <h2 class="text-gold mb-3">Réservation confirmée !</h2>

            <p class="lead text-white">Votre demande a été enregistrée avec succès.</p>

            <p class="text-dim mb-5">
                Une confirmation vous sera envoyée par email.<br />
                Notre service de conciergerie prendra contact vous pour finaliser les détails.
            </p>

            <div class="d-flex justify-content-center gap-3">
                <button class="btn btn-primary" @onclick="RetourAccueil">
                    <span class="oi oi-home me-2"></span> Accueil
                </button>
                <button class="btn btn-outline-light" @onclick="VoirVehicules">
                    <span class="oi oi-list me-2"></span> Notre Collection
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Success Icon -->
                <div class="text-center mb-5">
                    <div class="mb-3">
                        <span class="oi oi-circle-check" style="font-size: 5rem; color: var(--gold-primary);"></span>
                    </div>
                    <h2 class="text-gold">Excellence Confirmée</h2>
                    <p class="text-dim">Merci de votre confiance.</p>
                </div>

                <!-- Booking Receipt -->
                <div class="glass-panel p-0 overflow-hidden">
                    <div class="p-4 border-bottom border-light">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0 text-white">Bon de Réservation</h4>
                            <span class="badge @GetStatutBadgeClass(booking.Status)">
                                @GetStatutText(booking.Status)
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="row">
                            <!-- Client Info -->
                            <div class="col-md-6 mb-4">
                                <h5 class="text-gold border-bottom border-light pb-2 mb-3">Client</h5>
                                <div class="info-row mb-2">
                                    <span class="text-dim">Nom :</span>
                                    <span class="text-white ms-2">@booking.Client?.Prenom @booking.Client?.Nom</span>
                                </div>
                                <div class="info-row mb-2">
                                    <span class="text-dim">Email :</span>
                                    <span class="text-white ms-2">@booking.Client?.Email</span>
                                </div>
                                <div class="info-row">
                                    <span class="text-dim">Téléphone :</span>
                                    <span class="text-white ms-2">@booking.Client?.Telephone</span>
                                </div>
                            </div>

                            <!-- Vehicle Info -->
                            <div class="col-md-6 mb-4">
                                <h5 class="text-gold border-bottom border-light pb-2 mb-3">Véhicule</h5>
                                <div class="info-row mb-2">
                                    <span class="text-dim">Modèle :</span>
                                    <span class="text-white ms-2">@booking.Vehicule?.Marque @booking.Vehicule?.Modele</span>
                                </div>
                                <div class="info-row mb-2">
                                    <span class="text-dim">Catégorie :</span>
                                    <span class="text-white ms-2">@booking.Vehicule?.TypeVehicule?.Libelle</span>
                                </div>
                                <div class="info-row">
                                    <span class="text-dim">Tarif journalier :</span>
                                    <span class="text-gold ms-2">@booking.Vehicule?.PrixParJour.ToString("C")</span>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-6 mb-3">
                                <h5 class="text-gold border-bottom border-light pb-2 mb-3">Dates</h5>
                                <div class="d-flex align-items-center mb-2">
                                    <span class="oi oi-calendar text-dim me-2"></span>
                                    <span class="text-white">@booking.DateDebut.ToString("dd MMMM yyyy")</span>
                                    <span class="text-dim mx-2"> au </span>
                                    <span class="text-white">@booking.DateFin.ToString("dd MMMM yyyy")</span>
                                </div>
                                <div class="text-dim small">
                                    Durée : @((booking.DateFin - booking.DateDebut).Days) jour(s)
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <div class="total-box p-3 text-center">
                                    <div class="text-dim text-uppercase small mb-1">Montant Total</div>
                                    <div class="text-gold fs-3 fw-bold">@booking.PrixTotal.ToString("C")</div>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mt-4 d-flex align-items-center">
                            <span class="oi oi-info me-3 fs-5"></span>
                            <div>
                                <strong>Information :</strong> Votre réservation est actuellement en attente de validation.
                                Notre équipe vous contactera très prochainement.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-5 mb-5 d-flex justify-content-center gap-3 flex-wrap">
                    <button class="btn btn-success btn-lg" @onclick="TelechargerPDF">
                        <span class="oi oi-data-transfer-download me-2"></span> Télécharger le bon (PDF)
                    </button>
                    <button class="btn btn-primary btn-lg" @onclick="RetourAccueil">
                        <span class="oi oi-home me-2"></span> Accueil
                    </button>
                    <button class="btn btn-outline-light btn-lg" @onclick="VoirVehicules">
                        <span class="oi oi-list me-2"></span> Autres véhicules
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .total-box {
        background: rgba(212, 175, 55, 0.1);
        border: 1px solid var(--gold-dim);
        border-radius: 8px;
    }
    
    .border-light {
        border-color: rgba(255, 255, 255, 0.1) !important;
    }
</style>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public int? BookingId { get; set; }

    private Booking? booking;

    protected override async Task OnInitializedAsync()
    {
        if (BookingId.HasValue)
        {
            booking = await BookingService.GetByIdAsync(BookingId.Value);
        }
    }

    private string GetStatutText(StatutReservation statut)
    {
        return statut switch
        {
            StatutReservation.EnAttente => "En attente",
            StatutReservation.Confirmee => "Confirmée",
            StatutReservation.Annulee => "Annulée",
            StatutReservation.Terminee => "Terminée",
            _ => "Inconnu"
        };
    }
    
    private string GetStatutBadgeClass(StatutReservation statut)
    {
        return statut switch
        {
            StatutReservation.EnAttente => "bg-warning",
            StatutReservation.Confirmee => "bg-success",
            StatutReservation.Annulee => "bg-danger",
            StatutReservation.Terminee => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    private async Task TelechargerPDF()
    {
        if (booking == null) return;

        try
        {
            // Générer le PDF via le service
            var pdfBytes = PdfService.GeneratePdf(booking);
            
            // Télécharger le fichier PDF
            var fileName = $"Reservation_{booking.Id}_{DateTime.Now:yyyyMMdd}.pdf";
            await JS.InvokeVoidAsync("downloadFile", fileName, "application/pdf", pdfBytes);
        }
        catch (Exception)
        {
            // En cas d'erreur, utiliser window.print comme fallback
            await JS.InvokeVoidAsync("window.print");
        }
    }

    private void RetourAccueil()
    {
        Navigation.NavigateTo("/");
    }

    private void VoirVehicules()
    {
        Navigation.NavigateTo("/vehicules");
    }
}
