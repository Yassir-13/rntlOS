@page "/confirmation"
@rendermode InteractiveServer
@using rntlOS.Core.Services
@using rntlOS.Core.Models
@using rntlOS.Core.PdfService
@inject BookingService BookingService
@inject ReservationPdfService PdfService
@inject NavigationManager Navigation

<PageTitle>Confirmation - rntlOS</PageTitle>

<div class="container mt-5">
    @if (booking == null)
    {
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card text-center">
                    <div class="card-body p-5">
                        <div class="mb-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" fill="currentColor" class="bi bi-check-circle text-success" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z" />
                            </svg>
                        </div>

                        <h2 class="mb-3">Réservation confirmée !</h2>

                        <p class="lead">Votre demande de réservation a été enregistrée avec succès.</p>

                        <p class="text-muted">
                            Vous recevrez un email de confirmation prochainement.<br />
                            Notre équipe vous contactera pour finaliser votre réservation.
                        </p>

                        <div class="mt-4">
                            <button class="btn btn-primary me-2" @onclick="RetourAccueil">
                                Retour à l'accueil
                            </button>
                            <button class="btn btn-outline-primary" @onclick="VoirVehicules">
                                Voir d'autres véhicules
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-md-10">
                <!-- Success Icon -->
                <div class="text-center mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" fill="currentColor" class="bi bi-check-circle text-success" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                        <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z" />
                    </svg>
                    <h2 class="mt-3">Réservation Confirmée !</h2>
                </div>

                <!-- Booking Receipt -->
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Bon de Réservation</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Client Info -->
                            <div class="col-md-6 mb-4">
                                <h5 class="border-bottom pb-2">Client</h5>
                                <p class="mb-1"><strong>Nom:</strong> @booking.Client?.Prenom @booking.Client?.Nom</p>
                                <p class="mb-1"><strong>Email:</strong> @booking.Client?.Email</p>
                                <p class="mb-1"><strong>Téléphone:</strong> @booking.Client?.Telephone</p>
                            </div>

                            <!-- Vehicle Info -->
                            <div class="col-md-6 mb-4">
                                <h5 class="border-bottom pb-2">Véhicule</h5>
                                <p class="mb-1"><strong>Marque/Modèle:</strong> @booking.Vehicule?.Marque @booking.Vehicule?.Modele</p>
                                <p class="mb-1"><strong>Type:</strong> @booking.Vehicule?.TypeVehicule?.Libelle</p>
                                <p class="mb-1"><strong>Prix/jour:</strong> @booking.Vehicule?.PrixParJour.ToString("C")</p>
                            </div>
                        </div>

                        <hr />

                        <!-- Booking Details -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <h5 class="border-bottom pb-2">Dates</h5>
                                <p class="mb-1"><strong>Début:</strong> @booking.DateDebut.ToString("dd/MM/yyyy")</p>
                                <p class="mb-1"><strong>Fin:</strong> @booking.DateFin.ToString("dd/MM/yyyy")</p>
                                <p class="mb-1"><strong>Durée:</strong> @((booking.DateFin - booking.DateDebut).Days) jour(s)</p>
                            </div>

                            <div class="col-md-6 mb-3">
                                <h5 class="border-bottom pb-2">Prix</h5>
                                <p class="mb-1"><strong>Prix Total:</strong> <span class="text-success fs-4">@booking.PrixTotal.ToString("C")</span></p>
                                <p class="mb-1"><strong>Statut:</strong> 
                                    <span class="badge bg-warning">@GetStatutText(booking.Status)</span>
                                </p>
                            </div>
                        </div>

                        <div class="alert alert-info mt-3">
                            <strong>Information:</strong> Votre réservation est en attente de confirmation. Nous vous contacterons sous peu pour finaliser les détails.
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <button class="btn btn-success btn-lg me-2" @onclick="TelechargerPDF">
                        <span class="oi oi-data-transfer-download"></span> Télécharger le bon (PDF)
                    </button>
                    <button class="btn btn-primary btn-lg me-2" @onclick="RetourAccueil">
                        <span class="oi oi-home"></span> Retour à l'accueil
                    </button>
                    <button class="btn btn-outline-primary btn-lg" @onclick="VoirVehicules">
                        <span class="oi oi-list"></span> Voir d'autres véhicules
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    [SupplyParameterFromQuery]
    public int? BookingId { get; set; }

    private Booking? booking;

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        if (BookingId.HasValue)
        {
            booking = await BookingService.GetByIdAsync(BookingId.Value);
        }
    }

    private string GetStatutText(StatutReservation statut)
    {
        return statut switch
        {
            StatutReservation.EnAttente => "En attente",
            StatutReservation.Confirmee => "Confirmée",
            StatutReservation.Annulee => "Annulée",
            StatutReservation.Terminee => "Terminée",
            _ => "Inconnu"
        };
    }

    private async Task TelechargerPDF()
    {
        if (booking == null) return;

        try
        {
            // Générer le PDF via le service
            var pdfBytes = PdfService.GeneratePdf(booking);
            
            // Télécharger le fichier PDF
            var fileName = $"Reservation_{booking.Id}_{DateTime.Now:yyyyMMdd}.pdf";
            await JS.InvokeVoidAsync("downloadFile", fileName, "application/pdf", pdfBytes);
        }
        catch (Exception ex)
        {
            // En cas d'erreur, utiliser window.print comme fallback
            await JS.InvokeVoidAsync("window.print");
        }
    }

    private void RetourAccueil()
    {
        Navigation.NavigateTo("/");
    }

    private void VoirVehicules()
    {
        Navigation.NavigateTo("/vehicules");
    }
}